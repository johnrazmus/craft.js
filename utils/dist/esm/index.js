import t,{applyPatches as e,produceWithPatches as n}from"immer";import r,{useMemo as o,useRef as i,useReducer as a,useCallback as c,useEffect as s,useState as u,cloneElement as d,isValidElement as l}from"react";import h from"lodash.isequalwith";import f from"tiny-invariant";var p="ROOT",v="canvas-ROOT",m="Parent id cannot be ommited",g="Attempting to add a node with duplicated id",y="Node does not exist, it may have been removed",b='A <Element /> that is used inside a User Component must specify an `id` prop, eg: <Element id="text_element">...</Element> ',w="Placeholder required placement info (parent, index, or where) is missing",O="Node cannot be dropped into target parent",T="Target parent rejects incoming node",R="Current parent rejects outgoing node",E="Cannot move node that is not a direct child of a Canvas node",C="Cannot move node into a non-Canvas parent",I="A top-level Node cannot be moved",D="Root Node cannot be moved",N="Cannot move node into a descendant",S="The component type specified for this node does not exist in the resolver",k="The component specified in the <Canvas> `is` prop has additional Canvas specified in it's render template.",x="The node has specified a canDrag() rule that prevents it from being dragged",M="Invalid parameter Node Id specified",P="Attempting to delete a top-level Node",H=function(){return(H=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function U(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),o=0;for(e=0;e<n;e++)for(var i=arguments[e],a=0,c=i.length;a<c;a++,o++)r[o]=i[a];return r}var A={UNDO:"HISTORY_UNDO",REDO:"HISTORY_REDO",THROTTLE:"HISTORY_THROTTLE",IGNORE:"HISTORY_IGNORE"},L=function(){function t(){this.timeline=[],this.pointer=-1}return t.prototype.add=function(t,e){0===t.length&&0===e.length||(this.pointer=this.pointer+1,this.timeline.length=this.pointer,this.timeline[this.pointer]={patches:t,inversePatches:e,timestamp:Date.now()})},t.prototype.throttleAdd=function(t,e,n){if(void 0===n&&(n=500),0!==t.length||0!==e.length){if(this.timeline.length&&this.pointer>=0){var r=this.timeline[this.pointer],o=r.patches,i=r.timestamp;if((new Date).getTime()-i<n&&o.length===t.length&&o.every((function(e,n){var r=t[n];return r.op===e.op&&h(r.path,e.path)})))return void(this.throttledInversePatch||(this.throttledInversePatch=e))}this.add(t,this.throttledInversePatch||e),this.throttledInversePatch=null}},t.prototype.canUndo=function(){return this.pointer>=0},t.prototype.canRedo=function(){return this.pointer<this.timeline.length-1},t.prototype.undo=function(t){if(this.canUndo()){this.throttledInversePatch=null;var n=this.timeline[this.pointer].inversePatches;return this.pointer=this.pointer-1,e(t,n)}},t.prototype.redo=function(t){if(this.canRedo())return this.pointer=this.pointer+1,e(t,this.timeline[this.pointer].patches)},t}();function j(e,r,u,d){var l,h=o((function(){return new L}),[]),f=i([]),p=i();"function"==typeof e?l=e:(l=e.methods,f.current=e.ignoreHistoryForActions,p.current=e.normalizeHistory);var v=i(d);v.current=d;var m=o((function(){var e=p.current,r=f.current,o=v.current;return[function(i,a){var c,s=u&&q(u,(function(){return i}),h),d=n(i,(function(t){var e,n;switch(a.type){case A.UNDO:return h.undo(t);case A.REDO:return h.redo(t);case A.IGNORE:case A.THROTTLE:var r=a.payload,o=r[0],i=r.slice(1);(e=l(t,s))[o].apply(e,i);break;default:(n=l(t,s))[a.type].apply(n,a.payload)}})),f=d[0],p=d[1],v=d[2];return c=f,o&&o(f,i,{type:a.type,params:a.payload,patches:p},s,(function(t){var e=n(f,t);c=e[0],p=U(p,e[1]),v=U(e[2],v)})),[A.UNDO,A.REDO].includes(a.type)&&e&&(c=t(c,e)),U(r,[A.UNDO,A.REDO,A.IGNORE]).includes(a.type)||(a.type===A.THROTTLE?h.throttleAdd(p,v,a.config&&a.config.rate):h.add(p,v)),c},l]}),[h,l,u]),g=m[1],y=a(m[0],r),b=y[0],w=y[1],O=i();O.current=b;var T=o((function(){return u?q(u,(function(){return O.current}),h):[]}),[h,u]),R=o((function(){var t=Object.keys(g(null,null)),e=f.current;return H(H({},t.reduce((function(t,e){return t[e]=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return w({type:e,payload:t})},t}),{})),{history:{undo:function(){return w({type:A.UNDO})},redo:function(){return w({type:A.REDO})},throttle:function(n){return H({},t.filter((function(t){return!e.includes(t)})).reduce((function(t,e){return t[e]=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return w({type:A.THROTTLE,payload:U([e],t),config:{rate:n}})},t}),{}))},ignore:function(){return H({},t.filter((function(t){return!e.includes(t)})).reduce((function(t,e){return t[e]=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return w({type:A.IGNORE,payload:U([e],t)})},t}),{}))}}})}),[g]),E=c((function(){return O.current}),[]),C=o((function(){return new G(E)}),[E]);return s((function(){O.current=b,C.notify()}),[b,C]),o((function(){return{getState:E,subscribe:function(t,e,n){return C.subscribe(t,e,n)},actions:R,query:T,history:h}}),[R,T,C,E,h])}function q(t,e,n){var r=Object.keys(t()).reduce((function(n,r){var o;return H(H({},n),((o={})[r]=function(){for(var n,o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];return(n=t(e()))[r].apply(n,o)},o))}),{});return H(H({},r),{history:{canUndo:function(){return n.canUndo()},canRedo:function(){return n.canRedo()}}})}var G=function(){function t(t){this.subscribers=[],this.getState=t}return t.prototype.subscribe=function(t,e,n){var r=this,o=new Y((function(){return t(r.getState())}),e,n);return this.subscribers.push(o),this.unsubscribe.bind(this,o)},t.prototype.unsubscribe=function(t){if(this.subscribers.length){var e=this.subscribers.indexOf(t);if(e>-1)return this.subscribers.splice(e,1)}},t.prototype.notify=function(){this.subscribers.forEach((function(t){return t.collect()}))},t}(),Y=function(){function t(t,e,n){void 0===n&&(n=!1),this.collector=t,this.onChange=e,n&&this.collect()}return t.prototype.collect=function(){try{var t=this.collector();h(t,this.collected)||(this.collected=t,this.onChange&&this.onChange(this.collected))}catch(t){console.warn(t)}},t}(),_=function(t){return{left:parseInt(window.getComputedStyle(t).paddingLeft),right:parseInt(window.getComputedStyle(t).paddingRight),bottom:parseInt(window.getComputedStyle(t).paddingTop),top:parseInt(window.getComputedStyle(t).paddingBottom)}},B=function(t){return{left:parseInt(window.getComputedStyle(t).marginLeft),right:parseInt(window.getComputedStyle(t).marginRight),bottom:parseInt(window.getComputedStyle(t).marginTop),top:parseInt(window.getComputedStyle(t).marginBottom)}},F=function(t){var e=t.getBoundingClientRect(),n=e.x,r=e.y,o=e.top,i=e.left,a=e.bottom,c=e.right,s=e.width,u=e.height,d=B(t),l=_(t);return{x:Math.round(n),y:Math.round(r),top:Math.round(o),left:Math.round(i),bottom:Math.round(a),right:Math.round(c),width:Math.round(s),height:Math.round(u),outerWidth:Math.round(s+d.left+d.right),outerHeight:Math.round(u+d.top+d.bottom),margin:d,padding:l,inFlow:t&&t.parentElement&&!!z(t,t.parentElement)}},W=function(t){return window.getComputedStyle(t)},z=function(t,e){var n=W(t),r=W(e);if(!(n.overflow&&"visible"!==n.overflow||"none"!==r.float||e&&"flex"===r.display&&"column"!==r["flex-direction"])){switch(n.position){case"static":case"relative":break;default:return}switch(t.tagName){case"TR":case"TBODY":case"THEAD":case"TFOOT":return!0}switch(n.display){case"block":case"list-item":case"table":case"flex":return!0}}};function J(t,e){var n=t.subscribe,r=t.getState,o=t.actions,a=t.query,d=i(!0),l=i(null),h=i(e);h.current=e;var f=c((function(t){return H(H({},t),{actions:o,query:a})}),[o,a]);d.current&&e&&(l.current=e(r(),a),d.current=!1);var p=u(f(l.current)),v=p[0],m=p[1];return s((function(){var t;return h.current&&(t=n((function(t){return h.current(t,a)}),(function(t){m(f(t))}))),function(){t&&t()}}),[f,a,n]),v}function K(t,e){e&&("function"==typeof t?t(e):t.current=e)}function Q(t,e){var n=t.ref;return f("string"!=typeof n,"Cannot connect to an element with an existing string ref. Please convert it to use a callback ref instead, or wrap it into a <span> or <div>. Read more: https://facebook.github.io/react/docs/more-about-refs.html#the-ref-callback-attribute"),d(t,n?{ref:function(t){K(n,t),K(e,t)}}:{ref:e})}function V(t){return function(e,n){if(void 0===e&&(e=null),!l(e)){var r=e;return r&&t(r,n),r}var o=e;return function(t){if("string"!=typeof t.type)throw new Error}(o),Q(o,t)}}var X=function(t){return r.createElement("div",{style:H({position:"fixed",display:"block",opacity:1,borderStyle:"solid",borderWidth:"1px",borderColor:"transparent",zIndex:99999},t.style)})},Z=function(t){s(t,[])},$=function(t,e,n){return[t,e,n]},tt=function(){function t(t,e,n,r){var o=this;this.el=e,this.opts=n,this.handler=r,this.unsubscribe=t.subscribe((function(t){return{enabled:t.options.enabled}}),(function(t){var n=t.enabled;if(!document.body.contains(e))return o.remove(),o.unsubscribe();n?o.add():o.remove()}),!0)}return t.prototype.add=function(){var t=this,e=this.handler,n=e.init,r=e.events;this.cleanDOM=n&&n(this.el,this.opts),this.listenersToRemove=r&&r.map((function(e){var n=e[0],r=e[1],o=e[2],i=function(e){e.craft||(e.craft={blockedEvents:{},stopPropagation:function(){}}),function(t,e,n){for(var r=t.craft&&t.craft.blockedEvents[e]||[],o=0;o<r.length;o++){var i=r[o];if(n!==i&&n.contains(i))return!0}return!1}(e,n,t.el)||(e.craft.stopPropagation=function(){e.craft.blockedEvents[n]||(e.craft.blockedEvents[n]=[]),e.craft.blockedEvents[n].push(t.el)},r(e,t.opts))};return t.el.addEventListener(n,i,o),function(){return t.el.removeEventListener(n,i,o)}}))},t.prototype.remove=function(){this.cleanDOM&&(this.cleanDOM(),this.cleanDOM=null),this.listenersToRemove&&(this.listenersToRemove.forEach((function(t){return t()})),this.listenersToRemove=null)},t}(),et=function(){function t(t){this.wm=new WeakMap,this.store=t}return t.prototype.connectors=function(){var t=this,e=this.handlers()||{};return Object.keys(e).reduce((function(n,r){var o=e[r],i=o.init,a=o.events;return i||a?(n[r]=V((function(e,n){var o;if(e&&document.body.contains(e)){var c=t.wm.get(e);c&&c[r]||t.wm.set(e,H(H({},c),((o={})[r]=new tt(t.store,e,n,{init:i,events:a}),o)))}else t.wm.delete(e)})),n):(n[r]=function(){},n)}),{})},t.getConnectors=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=new(this.bind.apply(this,U([void 0],t)));return n.connectors()},t}(),nt=function(t,e){var n="Deprecation warning: "+t+" will be deprecated in future relases.",r=e.suggest,o=e.doc;r&&(n+=" Please use "+r+" instead."),o&&(n+="("+o+")"),console.warn(n)};export{v as DEPRECATED_ROOT_NODE,x as ERROR_CANNOT_DRAG,P as ERROR_DELETE_TOP_LEVEL_NODE,g as ERROR_DUPLICATE_NODEID,k as ERROR_INFINITE_CANVAS,y as ERROR_INVALID_NODEID,M as ERROR_INVALID_NODE_ID,w as ERROR_MISSING_PLACEHOLDER_PLACEMENT,O as ERROR_MOVE_CANNOT_DROP,T as ERROR_MOVE_INCOMING_PARENT,E as ERROR_MOVE_NONCANVAS_CHILD,R as ERROR_MOVE_OUTGOING_PARENT,D as ERROR_MOVE_ROOT_NODE,I as ERROR_MOVE_TOP_LEVEL_NODE,N as ERROR_MOVE_TO_DESCENDANT,C as ERROR_MOVE_TO_NONCANVAS_PARENT,m as ERROR_NOPARENT,S as ERROR_NOT_IN_RESOLVER,b as ERROR_TOP_LEVEL_ELEMENT_NO_ID,A as HISTORY_ACTIONS,et as Handlers,L as History,p as ROOT_NODE,X as RenderIndicator,Q as cloneWithRef,q as createQuery,$ as defineEventListener,nt as deprecationWarning,W as getComputedStyle,F as getDOMInfo,B as getDOMMargin,_ as getDOMPadding,z as styleInFlow,J as useCollector,Z as useEffectOnce,j as useMethods,V as wrapHookToRecognizeElement};
